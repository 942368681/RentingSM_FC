<!DOCTYPE html>
<html>

<head>
   <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
   <meta charset="UTF-8">
   <title></title>
   <link rel="stylesheet" href="../../css/iuapmobile.um.css">
   <link rel="stylesheet" href="../../css/fonts/iconfont.css">
   <link rel="stylesheet" href="index.css">
   <script src="../../js/summer.js"></script>
   <script src="../../js/jquery.min.js"></script>
   <script src="../../js/Frameworks/iuapmobile.frameworks.ui.js"></script>
   <script src="../../js/font.js" charset="utf-8"></script>
</head>

<body>
   <div class="um-win" id="index">
      <div class="um-content">
         <div class="box border">
            <textarea id="question" placeholder="亲，请输入需要解决的问题（必填）" maxlength="200"></textarea>
            <p class="showBox"><span id="txtShow">0/200</span></p>
         </div>
         <div class="box clearfix border">
            <div class="title-box">
               <span class="title">问题截图(非必填) </span>
               <span id="picShow" class="picShow">0/4</span>
            </div>
            <div id="uploadForm">
               <div id="ibox">
                  <div class="con" id="plus" onClick="showActionsheet();">
                     <div class="con-con">
                        <div class="font">
                           <span class="iconfont icon-add"></span>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
   <script type="text/javascript">
      /*********************************** Global Variable&&Constant Define ***********************************/
      var g_pathArr = [];

      /*********************************** Summer Lifecycle Handler Define ***********************************/
      summerready = function() {
         //$summer.fixStatusBar($summer.byId('header'));
         bindEvents()
         setTimeout(function() {
            //common.toast('功能暂未开放')
         }, 400)

      }
      /*********************************** Init Method Define ***********************************/
      function bindEvents() {
         $("#question").on("input propertychange", function() {
            var length = $(this).val().length;
            $('#txtShow').text(length + '/200');
         });
         var plus = $("#ibox .con-con .font");
         var phei = plus.parent().width() - 2;
         var pwid = plus.parent().width() - 2;
         plus.css({
            "width": pwid,
            "height": phei
         });
      }

      /*********************************** Private Method Define ***********************************/
      function closePic(obj) {
         var src = $(obj).prev("img").attr("src");
         g_pathArr.remove(src);
         $(obj).parent().parent(".con").remove();
         var len = $("#ibox .con").length - 1;
         $('#picShow').text(len + '/4');
         $("#plus").removeClass("none");
      }

      function camera() { //打开相机
         summer.openCamera({
            compressionRatio: 0.2,
            callback: function(args) {
               var imgPath = args.compressImgPath;
               g_pathArr.push(imgPath);
               var picDiv = '<div class="con">' + '<div class="con-con">' + '<img src="' + imgPath + '"><div class="bottomDelete"></div>' + '<span class="close iconfont icon-backspace" onClick="closePic(this);"></span>' + '</div></div>';
               $("#plus").before(picDiv);
               var len = $("#ibox .con").length - 1;
               $('#picShow').text(len + '/4');
               if (len == 4) {
                  $("#plus").addClass("none");
               }
            }
         })
      }

      function openPhotoAlbum() { //打开相册
         summer.openPhotoAlbum({
            compressionRatio: 0.2,
            callback: function(args) {
               var imgPath = args.compressImgPath;
               g_pathArr.push(imgPath);
               var picDiv = '<div class="con">' + '<div class="con-con">' + '<img src="' + imgPath + '"><div class="bottomDelete"></div>' + '<span class="close iconfont icon-backspace" onClick="closePic(this);"></span>' + '</div></div>';
               $("#plus").before(picDiv);
               var len = $("#ibox .con").length - 1;
               $('#picShow').text(len + '/4');
               if (len == 4) {
                  $("#plus").addClass("none");
               }
            }
         });
      }

      //数组新增remove方法
      Array.prototype.indexOf = function(val) {
         for (var i = 0; i < this.length; i++) {
            if (this[i] == val)
               return i;
         }
         return -1;
      };
      Array.prototype.remove = function(val) {
         var index = this.indexOf(val);
         if (index > -1) {
            this.splice(index, 1);
         }
      };

      /*********************************** DOM Event Handler Define ***********************************/
      function showActionsheet() {
         UM.actionsheet({
            title: '',
            items: ['拍照', '从相册中选择'],
            callbacks: [camera, openPhotoAlbum]
         });
      }

      //此处为友人才专用upload， 带参数和header的请求,上传图片
      function uploadHr() {
         var question = $.trim($("#question").val());
         if (question == "") {
            //common.toast("问题不能为空");
            summer.toast({
               "msg": "问题不能为空"
            })
            return false;
         }
         /*summer.toast({
               "msg" : "感谢您的反馈!"
          })*/
         //summer.closeWin();
         //summer.showProgress({
         //	title : '加载中...'
         //});
         manyfileupload();

      }

      function manyfileupload() { //多图文上传方法
         if (!summer.netAvailable()) {
            summer.toast({
               "msg": "网络连接失败，请检查网络"
            })
            return;
         }
         summer.showProgress();
         // 判断变量
         var photoPath;
         var photoList = [];
         if (g_pathArr.length == 0) {
            photoList = [];
         } else {
            for (var i = 0, length = g_pathArr.length; i < length; i++) {
               var photoPath = {
                  "fileURL": "",
                  "type": "image/png",
                  "name": "file"
               };
               photoPath.fileURL = g_pathArr[i];
               photoList.push(photoPath);
            }
         }
         //var SERVER = 'http://10.11.65.58:8000/api/bi/v2/face/upload';
         var userinfo = summer.getStorage("userinfo");
         //var memberId=userinfo.id;
         //var memberAccount=userinfo.account;
         //var SERVER = 'http://10.11.65.59:80/api/bi/v2/face/upload';
         var SERVER = G_COMMON_URL + '/advice/addAdvice';
         //var SERVER = 'http://172.16.199.1:8900/advice/addAdvice';

         var params = {
            context: $.trim($("#question").val())
         };
         var header = getDeviceidAndToken();
         summer.multiUpload({
            fileArray: photoList,
            params: params,
            headers: header,
            SERVER: SERVER
         }, "successCallback()", "errorCallback()");

      };

      function successCallback(args) {
         //	g_path = [];
         //alert("成功回调" + JSON.stringify(args));
         /*  for(var i=0;i<g_path.length;i++){
                $("li img[src='"+g_path[i]+"']").addClass("haveId").removeClass("photolist");
           };
           g_path = [];*/
         summer.hideProgress();
         summer.toast({
            "msg": "感谢您的反馈"
         });
         summer.closeWin();
         // location.reload();
      }

      function errorCallback(args) {
         //alert("失败回调" + JSON.stringify(args));
         summer.hideProgress();
         summer.toast({
            "msg": "上传失败"
         })
      }
   </script>
</body>

</html>
